

===== BEGIN code/04_util_qa.R =====
library(here)
library(ggplot2)

# QAãƒ¢ãƒ¼ãƒ‰ï¼ˆç’°å¢ƒå¤‰æ•°ã§ON/OFFï¼‰
qa_on <- function() identical(Sys.getenv("QA", "0"), "1")

# å‡ºåŠ›å…ˆã‚’ options() ã‹ã‚‰å–å¾—ã€‚æœªè¨­å®šãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
qa_dir <- function(kind = c("png","html")) {
  kind <- match.arg(kind)
  root <- getOption("spat.qa_root",  here::here("output","qa"))
  dir  <- if (kind == "png")  getOption("spat.qa_png",  file.path(root, "png")) 
          else                 getOption("spat.qa_html", file.path(root, "html"))
  dir.create(dir, recursive = TRUE, showWarnings = FALSE)
  dir
}

qa_png <- function(p, name, width_px = 1600, height_px = 1000, dpi = 96) {
  if (!qa_on()) return(invisible(NULL))
  stopifnot(inherits(p, "ggplot"))
  f <- file.path(qa_dir("png"), paste0(name, ".png"))
  ggsave(filename = f, plot = p,
         width = width_px / dpi, height = height_px / dpi, dpi = dpi)
  message("QA png -> ", f); invisible(f)
}

qa_html <- function(m, name) {
  if (!qa_on()) return(invisible(NULL))
  if (!requireNamespace("mapview", quietly = TRUE)) {
    message("mapview æœªå°å…¥ã®ãŸã‚ qa_html ã‚’ã‚¹ã‚­ãƒƒãƒ—"); return(invisible(NULL))
  }
  f <- file.path(qa_dir("html"), paste0(name, ".html"))
  mapview::mapshot(m, url = f)
  message("QA html -> ", f); invisible(f)
}
===== END code/04_util_qa.R =====


===== BEGIN code/03_util_strings.R =====
#code/03_util_strings.R

library(stringr)
library(stringi)

#é§…åç­‰è¡¨è¨˜æºã‚Œå¯¾å¿œæªç½®
norm_ja <- function(x){
  s <- stringi::stri_trans_nfkc(x)                      # å…¨è§’/åŠè§’ãƒ»åˆæˆæ–‡å­—ã®æ­£è¦åŒ–
  s <- stringr::str_replace_all(s, "ï¼ˆ.*?ï¼‰|\\(.*?\\)", "")  # ä¸¸æ‹¬å¼§å†…ã‚’é™¤å»
  s <- stringr::str_replace_all(s, "é§…", "")            # ã€Œé§…ã€ã‚’é™¤å»
  s <- stringr::str_replace_all(s, "[ ã€€\t]", "")       # ç©ºç™½ã‚’é™¤å»ï¼ˆå…¨è§’/åŠè§’/ã‚¿ãƒ–ï¼‰
  s <- stringr::str_replace_all(s, "ãƒ»", "")            # ä¸­ç‚¹ã‚’é™¤å»
  s <- stringr::str_replace_all(s, "[âˆ’â€•ãƒ¼]", "-")       # é•·éŸ³ã®è¡¨è¨˜ã‚†ã‚Œçµ±ä¸€
  stringr::str_to_lower(s)                              # å°æ–‡å­—åŒ–
}
===== END code/03_util_strings.R =====


===== BEGIN code/01_config_paths.R =====
#code/01_config_paths.R

library(here)

#path
RAW_DIR    <- here::here("data_raw")
ADM_DIR    <- here::here("data_raw", "ksj_n03_adm")ã€€#è¡Œæ”¿ç•Œãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
STATION_GJ <- here::here("data_raw", "ksj_n02_railway","N02-24_Station.geojson") #é‰„é“ãƒ‡ãƒ¼ã‚¿

#å‡ºåŠ›å…ˆ
OUT_DIR_GJ  <- here::here("data_fmt", "fmt_gj")
OUT_DIR_RDS <- here::here("data_fmt", "fmt_rds")

# --- å…¥å‡ºåŠ›ã®è¦ç´„ ---
L02_STD_DIR   <- here::here("data_fmt", "l02_std")  # å¹´ã”ã¨ã«geojsonã‚’æ ¼ç´ã—ã¦ã„ã‚‹è¦ª
PANEL_DIR     <- here::here("data_fmt", "panel")    # é›†è¨ˆæ¸ˆã¿ãƒ‘ãƒãƒ«ã®æ ¼ç´å…ˆ
MATCH_DIR     <- here::here("data_fmt", "matched")  # ãƒãƒƒãƒãƒ³ã‚°çµæœã®æ ¼ç´å…ˆ
FIG_DIR       <- here::here("output", "fig")        # å›³ã®å‡ºåŠ›å…ˆ

#qaç”¨ã®path
OUTPUT_DIR    <- here::here("output")
QA_ROOT_DIR <- Sys.getenv("SPAT_QA_ROOT", unset = file.path(OUTPUT_DIR, "qa"))
QA_PNG_DIR  <- file.path(QA_ROOT_DIR, "png")
QA_HTML_DIR <- file.path(QA_ROOT_DIR, "html")

# åˆå›ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆ
dir.create(QA_PNG_DIR,  recursive = TRUE, showWarnings = FALSE)
dir.create(QA_HTML_DIR, recursive = TRUE, showWarnings = FALSE)
===== END code/01_config_paths.R =====


===== BEGIN code/fn_read_l02_year.R =====
#code/fn_read_l02_year.R

library(sf)
library(dplyr)
library(here)

source(here("code","01_config_paths.R"))      # L02_DIR_FMT ãªã©ã®PATH
source(here("code","02_config_params.R"))     # EPSG_WGS84, TARGET_PREFS ãªã©

# ã©ã¡ã‚‰ã‹å­˜åœ¨ã™ã‚‹ç”¨é€”åŒºåˆ†åˆ—åã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
.pick_use_col <- function(nm) {
  cand <- c("L02_001", "L02_003", "ç”¨é€”åŒºåˆ†")
  intersect(cand, nm)[1]  # æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®
}

# å¹´ã”ã¨ã®çœŒåˆ¥GeoJSONã‚’æŸã­ã¦æ¨™æº–åŒ–ã—ã¦è¿”ã™
read_l02_year <- function(year,
                          drop_forest = TRUE,        # æ—åœ°(020)ã‚’é™¤å¤–
                          keep_cols   = c("price_yen_m2","log_price","year",
                                          "pref_code","use_code","road_dist_m",
                                          "geometry")) {
  gj_dir <- here("data_fmt","l02_std", as.character(year))  # æ—¢ã«æ•´ç†æ¸ˆã¿ã®å ´æ‰€
  files  <- list.files(gj_dir, pattern="\\.geojson$", full.names = TRUE)
  stopifnot(length(files) > 0)
  
  l <- map(files, ~ st_read(.x, quiet = TRUE)) |> list_rbind()
  
  # åˆ—ã®å­˜åœ¨ã«å¿œã˜ã¦å®‰å…¨ã«æ‹¾ã†
  nm  <- names(l)
  use_col  <- .pick_use_col(nm)
  year_col <- dplyr::case_when("L02_005" %in% nm ~ "L02_005",
                               TRUE ~ NA_character_)
  price_col <- dplyr::case_when("L02_006" %in% nm ~ "L02_006",
                                TRUE ~ NA_character_)
  dist_col <- dplyr::case_when("L02_045" %in% nm ~ "L02_045",
                               TRUE ~ NA_character_)
  
  if (is.na(price_col)) stop("ä¾¡æ ¼åˆ— L02_006 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
  if (is.na(year_col))  warning("L02_005(å¹´åº¦)ãŒç„¡ã„ãŸã‚ã€å¼•æ•°yearã‚’æ¡ç”¨ã—ã¾ã™")
  
  out <- l |>
    mutate(
      year         = if (!is.na(year_col)) as.integer(.data[[year_col]]) else as.integer(year),
      price_yen_m2 = suppressWarnings(as.numeric(.data[[price_col]])),
      use_code     = if (!is.na(use_col)) as.character(.data[[use_col]]) else NA_character_,
      pref_code    = if ("L02_020" %in% nm) as.character(.data[["L02_020"]]) else NA_character_,
      road_dist_m  = if (!is.na(dist_col)) suppressWarnings(as.integer(.data[[dist_col]])) else NA_integer_
    ) |>
    st_as_sf() |>
    st_transform(EPSG_WGS84)
  
  # æ—åœ°é™¤å¤–ï¼ˆå˜ä½é•ã„å¯¾ç­–ï¼‰
  if (drop_forest && "use_code" %in% names(out)) {
    out <- out |> filter(use_code != "020")
  }
  
  # åŸºæœ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
  out <- out |>
    filter(is.finite(price_yen_m2), price_yen_m2 > 0) |>
    mutate(log_price = log(price_yen_m2)) |>
    select(any_of(keep_cols))
  
  return(out)
}
===== END code/fn_read_l02_year.R =====


===== BEGIN code/fn_build_station_bands.R =====
# code/fn_build_station_bands.R
library(sf)
library(dplyr)
library(here)

source(here("code","01_config_paths.R"))
source(here("code","02_config_params.R"))
source(here("code","04_util_qa.R"))

# ------------------------------------------------------------
# é§…ã”ã¨ã®è·é›¢å¸¯ï¼ˆãƒªãƒ³ã‚°ï¼‰ãƒãƒªã‚´ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°
# å¼•æ•°:
#   stn_flag   : ã®ãã¿/ã²ã‹ã‚Š/ã“ã ã¾ã®åœè»Šãƒ•ãƒ©ã‚°ã‚’æŒã¤é§…ç‚¹(sf)ã€‚
#                NULL ã®å ´åˆã¯ readRDS(STATIONS_OUT_RDS) ã§èª­ã¿è¾¼ã‚€
#   breaks_km  : è·é›¢å¸¯ã®å¢ƒç•Œ (km)ã€‚ä¾‹: c(0, 0.5, 1, 2, 3)
#   preview    : TRUE ã®ã¨ãã€mapview ãŒåˆ©ç”¨å¯èƒ½ãªã‚‰ç°¡æ˜“QAå¯è¦–åŒ–ã‚’å‡ºåŠ›
#   preview_n  : ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ä½¿ç”¨ã™ã‚‹é§…ã®ä»¶æ•°
#   preview_id : å¯è¦–åŒ–ã®ä¿å­˜IDï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã«åˆ©ç”¨ï¼‰
# è¿”ã‚Šå€¤:
#   é§… Ã— è·é›¢å¸¯ãƒªãƒ³ã‚°ï¼ˆãƒãƒªã‚´ãƒ³ï¼‰ã® sf
# ------------------------------------------------------------
build_station_bands <- function(stn_flag  = NULL,
                                breaks_km = BAND_BREAKS_KM,
                                preview   = qa_on(),
                                preview_n = 3L,
                                preview_id = "32_bands_sample") {

  # 1) å…¥åŠ›ã®é§…ç‚¹ã‚’ç”¨æ„ï¼ˆNULLãªã‚‰æ—¢å®šRDSã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
  if (is.null(stn_flag)) stn_flag <- readRDS(STATIONS_OUT_RDS)

  # 2) ãƒãƒƒãƒ•ã‚¡è¨ˆç®—ã®ãŸã‚ã€å¹³é¢ç›´äº¤åº§æ¨™ã¸å¤‰æ›ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰
  stn_bufs <- stn_flag |>
    sf::st_transform(EPSG_METRIC)

  # 3) è·é›¢å¸¯ã®å¢ƒç•Œ(km)ã‚’ç¢ºèªï¼ˆæ˜‡é †ãƒ»é‡è¤‡ãªã—ï¼‰
  kms <- unique(sort(breaks_km))
  stopifnot(length(kms) >= 2L)

  # 4) å„å¢ƒç•Œã®ã€Œå¤–å´åŠå¾„ã€ã§é€£ç¶šãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆï¼ˆå¤–å´ã‚·ã‚§ãƒ«ï¼‰
  outer_list <- lapply(seq_len(length(kms) - 1L), function(i) {
    r2_m <- kms[i + 1L] * 1000  # km â†’ m
    sf::st_buffer(stn_bufs, r2_m)
  })

  # 5) ãƒªãƒ³ã‚°åŒ–ï¼ˆå¤–å´ âˆ’ ä¸€ã¤å†…å´ï¼‰ã—ã¦ WGS84 ã«æˆ»ã™
  ring_list <- lapply(seq_along(outer_list), function(i) {
    r_from <- kms[i]
    r_to   <- kms[i + 1L]
    outer  <- outer_list[[i]]
    inner  <- if (i == 1L) sf::st_buffer(stn_bufs, 0) else outer_list[[i - 1L]]
    ring   <- sf::st_difference(outer, inner)           # ãƒ‰ãƒ¼ãƒŠãƒ„çŠ¶ã®å¸¯
    ring   <- sf::st_transform(ring, EPSG_WGS84)        # è¡¨ç¤ºãƒ»å…±æœ‰ã—ã‚„ã™ã„åœ°ç†åº§æ¨™ã¸æˆ»ã™
    ring$band_from_km <- r_from
    ring$band_to_km   <- r_to
    ring
  })

  # 6) çµåˆã—ã¦ã€é§…å±æ€§ï¼‹å¸¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ãˆã‚‹
  bands <- do.call(rbind, ring_list) |>
    dplyr::mutate(band_id = paste0("[", band_from_km, ",", band_to_km, ")")) |>
    dplyr::select(
      station_jp = station, station_key, nozomi, hikari, kodama,
      service_tier, band_from_km, band_to_km, band_id, geometry
    )

  #qaå‡¦ç†
  if (preview && requireNamespace("mapview", quietly = TRUE)) {
    sample_keys <- utils::head(unique(bands$station_key), preview_n)
    m <- mapview::mapview(
           bands |> dplyr::filter(station_key %in% sample_keys),
           zcol = "band_id", layer.name = "bands"
         ) +
         mapview::mapview(
           stn_flag |> dplyr::filter(station_key %in% sample_keys),
           color = "black", layer.name = "stations"
         )
    qa_html(m, preview_id)
  }

  # 8) sf ã‚’è¿”ã™ï¼ˆä¿å­˜ã¯å‘¼ã³å‡ºã—å´ã§å®Ÿæ–½ï¼‰
  bands
}
===== END code/fn_build_station_bands.R =====


===== BEGIN code/fn_build_station_band_panel.R =====
# code/fn_build_station_band_panel.R
# ç›®çš„ï¼š
#   ãƒ»L02ï¼ˆéƒ½é“åºœçœŒåœ°ä¾¡èª¿æŸ»ï¼‰ã® GeoJSON ã‚’å¹´ã”ã¨ã«èª­ã¿è¾¼ã‚€
#   ãƒ»é§…Ã—è·é›¢å¸¯ãƒªãƒ³ã‚°ï¼ˆbandï¼‰ã¨ç©ºé–“çµåˆ
#   ãƒ»é§…Ã—è·é›¢å¸¯Ã—å¹´ å˜ä½ã«é›†è¨ˆï¼ˆå¹³å‡ãƒ»ä¸­å¤®å€¤ãªã©ï¼‰
#   ãƒ»å¹´ãƒ«ãƒ¼ãƒ—ã§ãƒ‘ãƒãƒ«åŒ–ã—ã¦è¿”ã™ï¼ˆå¿…è¦ãªã‚‰ä¿å­˜ï¼‰
#
# ä¾å­˜ï¼š
#   - code/01_config_paths.R       : DATA_L02_GJ_ROOT, STATIONS_OUT_RDS ãªã©ã®å…¥å‡ºåŠ›ãƒ‘ã‚¹å®šç¾©
#   - code/02_config_params.R      : TARGET_PREF_CODES, EPSG_WGS84 ç­‰ã®åˆ†æå®šæ•°
#   - code/fn_build_station_bands.R: build_station_bands()ï¼ˆé§…Ã—è·é›¢å¸¯ã®ãƒªãƒ³ã‚°ç”Ÿæˆï¼‰
#
# æœŸå¾…ã™ã‚‹ L02 ã®ä¸»ãªåˆ—ï¼ˆGeoJSONæƒ³å®šï¼‰ï¼š
#   - L02_005 : å¹´åº¦ï¼ˆè¥¿æš¦ã®å¹´ï¼‰
#   - L02_006 : ä¾¡æ ¼ [å††/ã¡]ï¼ˆæ£®æ—ï¼ˆ020ï¼‰ã¯ [å††/10a] ã ãŒé€šå¸¸ã¯éƒ½å¸‚ç”¨é€”ã‚’å¯¾è±¡ã«ã™ã‚‹ãŸã‚é™¤å¤–ãŒç„¡é›£ï¼‰
#   - L02_020 : è¡Œæ”¿åŒºåŸŸã‚³ãƒ¼ãƒ‰ï¼ˆ5æ¡ã€å…ˆé ­2æ¡ãŒéƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ï¼‰
#   - geometry: ãƒã‚¤ãƒ³ãƒˆ
#
# å‚™è€ƒï¼š
#   ãƒ»æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œé–¢æ•°ç¾¤ã€ã‚’æä¾›ã—ã¾ã™ã€‚å®Ÿè¡Œã¯ scripts/ å´ã‹ã‚‰è¡Œã„ã€
#     ãã“ã§ã¯å½“è©²é–¢æ•°ã‚’ source() ã—ã¦ä½¿ã†æ–¹é‡ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

suppressPackageStartupMessages({
  library(sf)
  library(dplyr)
  library(purrr)
  library(here)
})

# è¨­å®šã®èª­ã¿è¾¼ã¿ï¼ˆãƒ‘ã‚¹ï¼å®šæ•°ï¼‰
source(here("code","01_config_paths.R"))
source(here("code","02_config_params.R"))

# =============================================================================
# 1) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šæŒ‡å®šå¹´ã® L02 GeoJSON ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
# -----------------------------------------------------------------------------
# å¼•æ•°ï¼š
#   year : æ•°å€¤ã¾ãŸã¯æ–‡å­—åˆ—ï¼ˆä¾‹ï¼š2020ï¼‰
#   root : å¹´åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã®è¦ªï¼ˆ01_config_paths.R ã® DATA_L02_GJ_ROOT ã‚’æƒ³å®šï¼‰
# è¿”ã‚Šå€¤ï¼š
#   è©²å½“å¹´ãƒ•ã‚©ãƒ«ãƒ€å†…ã® *.geojson ã®ãƒ•ãƒ«ãƒ‘ã‚¹æ–‡å­—åˆ—ãƒ™ã‚¯ãƒˆãƒ«
# =============================================================================
list_l02_files <- function(year, root = DATA_L02_GJ_ROOT) {
  year_dir <- file.path(root, as.character(year))
  if (!dir.exists(year_dir)) stop("L02å¹´åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ", year_dir)
  files <- list.files(year_dir, pattern = "\\.geojson$", full.names = TRUE)
  if (length(files) == 0) stop("å¹´", year, "ã® L02 GeoJSON ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
  files
}

# =============================================================================
# 2) æŒ‡å®šå¹´ã® L02 ã‚’å®‰å…¨ã«èª­ã¿è¾¼ã¿ï¼†å‰å‡¦ç†
# -----------------------------------------------------------------------------
# ã™ã‚‹ã“ã¨ï¼š
#   ãƒ»å¹´ãƒ•ã‚©ãƒ«ãƒ€å†…ã®éƒ½é“åºœçœŒåˆ¥ GeoJSON ã‚’ã™ã¹ã¦èª­ã¿å–ã‚Š
#   ãƒ»ï¼ˆå¿…è¦ãªã‚‰ï¼‰å¯¾è±¡éƒ½é“åºœçœŒã«ãƒ•ã‚£ãƒ«ã‚¿
#   ãƒ»åº§æ¨™ç³»ã‚’ WGS84 ã«çµ±ä¸€
#   ãƒ»key åˆ—ã‚’æ¨™æº–åŒ–ï¼ˆyear, pref_code, price_yen_m2, log_priceï¼‰
# å¼•æ•°ï¼š
#   year        : æ•°å€¤ or æ–‡å­—åˆ—
#   target_pref : 2æ¡ã®éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆä¾‹ï¼šc("22","23",...)ï¼‰
# è¿”ã‚Šå€¤ï¼š
#   sfï¼ˆãƒã‚¤ãƒ³ãƒˆï¼‰
# =============================================================================
read_l02_year <- function(year, target_pref = TARGET_PREF_CODES) {
  files <- list_l02_files(year)

  # çœŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ â†’ è¡Œçµåˆï¼ˆsf ã®ã¾ã¾ï¼‰
  l02_list <- map(files, ~ sf::st_read(.x, quiet = TRUE))
  l02_sf   <- do.call(rbind, l02_list)

  # åº§æ¨™ç³»ã‚’ WGS84 ã¸ï¼ˆå¯è¦–åŒ–ãƒ»å…±æœ‰ã§æ‰±ã„ã‚„ã™ãï¼‰
  l02_sf <- sf::st_transform(l02_sf, EPSG_WGS84)

  # åˆ—åã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¨æœ€å°é™ã®æ­£è¦åŒ–
  cols <- names(l02_sf)

  # å¹´ï¼ˆL02_005ï¼‰ãŒãªã‘ã‚Œã° year åˆ—ãªã©ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  year_col <- if ("L02_005" %in% cols) "L02_005" else if ("year" %in% cols) "year" else NA_character_
  if (is.na(year_col)) stop("L02 å¹´åº¦åˆ—ï¼ˆL02_005 / yearï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

  # ä¾¡æ ¼ [å††/ã¡] åˆ—ã€‚æ¨™æº–åã«åˆã‚ã› price_yen_m2 ã‚’ä½œã‚‹
  if ("L02_006" %in% cols) {
    price_col <- "L02_006"
  } else if ("price_yen_m2" %in% cols) {
    price_col <- "price_yen_m2"
  } else {
    stop("ä¾¡æ ¼åˆ—ï¼ˆL02_006 / price_yen_m2ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
  }

  # è¡Œæ”¿åŒºåŸŸã‚³ãƒ¼ãƒ‰ï¼ˆéƒ½é“åºœçœŒ2æ¡æŠ½å‡ºã«ä½¿ç”¨ï¼‰
  pref_col <- if ("L02_020" %in% cols) "L02_020" else if ("pref_code" %in% cols) "pref_code" else NA_character_
  if (is.na(pref_col)) stop("è¡Œæ”¿ã‚³ãƒ¼ãƒ‰åˆ—ï¼ˆL02_020 / pref_codeï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

  # æœ€å°é™ã®åˆ—ã¸ã‚¹ãƒªãƒ åŒ–
  l02_sf <- l02_sf |>
    mutate(
      year         = as.integer(.data[[year_col]]),
      pref_code_5d = as.character(.data[[pref_col]]),
      price_yen_m2 = as.numeric(.data[[price_col]])
    ) |>
    # å…ˆé ­2æ¡ã‚’éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ã¨ã—ã¦æŠ½å‡ºï¼ˆä¾‹ï¼š"22xxx" -> "22"ï¼‰
    mutate(pref2 = substr(pref_code_5d, 1, 2)) |>
    select(year, pref2, price_yen_m2, geometry)

  # å¯¾è±¡éƒ½é“åºœçœŒã ã‘ã«ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¿…è¦ãªã„å ´åˆã¯ TARGET_PREF_CODES ã‚’ NULL ã«ã—ã¦ãŠãï¼‰
  if (!is.null(target_pref) && length(target_pref) > 0) {
    l02_sf <- filter(l02_sf, pref2 %in% target_pref)
  }

  # ä¾¡æ ¼ã® log ã‚‚ç”¨æ„ï¼ˆã‚¼ãƒ­ã‚„NAã¯é™¤å¤–çš„ã«æ‰±ã†ï¼‰
  l02_sf <- l02_sf |>
    mutate(log_price = ifelse(is.finite(price_yen_m2) & price_yen_m2 > 0,
                              log(price_yen_m2), NA_real_))

  l02_sf
}

# =============================================================================
# 3) L02 ã¨ é§…Ã—è·é›¢å¸¯ï¼ˆbandsï¼‰ã‚’ç©ºé–“çµåˆ
# -----------------------------------------------------------------------------
# ã™ã‚‹ã“ã¨ï¼š
#   ãƒ»ãƒã‚¤ãƒ³ãƒˆï¼ˆL02ï¼‰ âˆˆ ãƒãƒªã‚´ãƒ³ï¼ˆbandsï¼‰ ã§çµåˆï¼ˆst_within / st_intersectsï¼‰
#   ãƒ»é§…å±æ€§ï¼ˆnozomi/hikari/kodama, band_id ç­‰ï¼‰ã‚’ä»˜ä¸
# å¼•æ•°ï¼š
#   l02_sf : read_l02_year() ã®æˆ»ã‚Šï¼ˆãƒã‚¤ãƒ³ãƒˆ sfï¼‰
#   bands  : build_station_bands() ã®æˆ»ã‚Šï¼ˆãƒãƒªã‚´ãƒ³ sfï¼‰
#   join_fun : ç©ºé–“çµåˆé–¢æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šst_withinï¼‰
# è¿”ã‚Šå€¤ï¼š
#   l02_joined : L02 ã«é§…Ã—è·é›¢å¸¯å±æ€§ãŒä»˜ã„ãŸ sfï¼ˆå¿…è¦ãªã‚‰ geometry ã‚’å¾Œã§è½ã¨ã™ï¼‰
# =============================================================================
join_l02_to_bands <- function(l02_sf, bands, join_fun = sf::st_within) {
  # st_join ã¯å·¦å´ã® geometry ã‚’ç¶­æŒã™ã‚‹ï¼ˆãƒã‚¤ãƒ³ãƒˆå¯†åº¦ãŒé«˜ã„ã®ã§å¾Œã§ geometry ã‚’è½ã¨ã™æƒ³å®šï¼‰
  l02_joined <- sf::st_join(l02_sf, bands, join = join_fun)

  # é§…ã«ç´ã¥ã‹ãªã„ç‚¹ï¼ˆè·é›¢å¸¯å¤–ï¼‰ã¯é™¤å¤–ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ–¹é‡å¤‰æ›´å¯ï¼‰
  l02_joined <- filter(l02_joined, !is.na(station_key))

  l02_joined
}

# =============================================================================
# 4) é§…Ã—è·é›¢å¸¯Ã—å¹´ ã§é›†è¨ˆï¼ˆå¹³å‡ãƒ»ä¸­å¤®å€¤ãªã©ï¼‰
# -----------------------------------------------------------------------------
# å¼•æ•°ï¼š
#   l02_joined : join_l02_to_bands() ã®æˆ»ã‚Š
#   price_var  : é›†è¨ˆå¯¾è±¡ã®æ•°å€¤åˆ—åãƒ™ã‚¯ãƒˆãƒ«ï¼ˆä¾‹ï¼šc("log_price","price_yen_m2")ï¼‰
#   agg        : é›†è¨ˆé–¢æ•°åãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ"mean","median","sd","p25" ç­‰ã€ä¸‹ã§å¯¾å¿œï¼‰
#   min_pts    : é›†è¨ˆã«å¿…è¦ãªæœ€å°ã‚µãƒ³ãƒ—ãƒ«æ•°ï¼ˆæœªæº€ã¯ NAï¼‰
# è¿”ã‚Šå€¤ï¼š
#   tibble/data.frameï¼ˆgeometry ãªã—ï¼‰
# å‚™è€ƒï¼š
#   ãƒ»åˆ—åã¯ {é›†è¨ˆé–¢æ•°}_{å¤‰æ•°} ã¨ã„ã†å½¢ã§ä½œã‚Šã¾ã™ï¼ˆä¾‹ï¼šmean_log_priceï¼‰
# =============================================================================
summarise_bands <- function(l02_joined,
                            price_var = c("log_price","price_yen_m2"),
                            agg       = c("mean","median"),
                            min_pts   = 3L) {

  # é›†è¨ˆé–¢æ•°ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
  agg_funs <- list(
    mean   = ~ mean(.x, na.rm = TRUE),
    median = ~ median(.x, na.rm = TRUE),
    sd     = ~ stats::sd(.x, na.rm = TRUE),
    p25    = ~ stats::quantile(.x, 0.25, na.rm = TRUE),
    p75    = ~ stats::quantile(.x, 0.75, na.rm = TRUE)
  )
  stopifnot(all(agg %in% names(agg_funs)))

  # é›†è¨ˆã‚­ãƒ¼ï¼ˆé§…ãƒ»è·é›¢å¸¯ãƒ»å¹´ï¼‰
  by_keys <- c("year","station_key","station_jp","band_id",
               "band_from_km","band_to_km",
               "nozomi","hikari","kodama","service_tier")

  # ã¾ãš geometry ã‚’è½ã¨ã—ã¦è»½é‡åŒ–
  df <- l02_joined |>
    sf::st_drop_geometry() |>
    select(all_of(by_keys), all_of(price_var))

  # ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  df_grp <- group_by(df, across(all_of(by_keys)))

  # ã‚µãƒ³ãƒ—ãƒ«æ•°
  out <- summarise(df_grp, n = dplyr::n(), .groups = "drop_last")

  # å¤‰æ•°Ã—é›†è¨ˆé–¢æ•°ã®çµ„ã¿åˆã‚ã›ã§åˆ—ã‚’è¿½åŠ 
  for (v in price_var) {
    for (a in agg) {
      col_nm <- paste0(a, "_", v)
      out[[col_nm]] <- df_grp |>
        summarise(val = agg_funs[[a]](.data[[v]]), .groups = "drop_last") |>
        pull(val)
    }
  }

  out <- ungroup(out)

  # ã‚µãƒ³ãƒ—ãƒ«æ•°ãŒé–¾å€¤æœªæº€ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯é›†è¨ˆå€¤ã‚’ NA ã«ï¼ˆn ã¯æ®‹ã™ï¼‰
  if (is.finite(min_pts) && min_pts > 0) {
    mask <- out$n < min_pts
    value_cols <- setdiff(names(out), c(by_keys, "n"))
    out[mask, value_cols] <- NA_real_
  }

  as.data.frame(out)
}

# =============================================================================
# 5) 1å¹´åˆ†ã®ãƒ‘ãƒãƒ«ï¼ˆé§…Ã—è·é›¢å¸¯Ã—å¹´ã®é›†è¨ˆï¼‰ã‚’ä½œã‚‹
# -----------------------------------------------------------------------------
# å¼•æ•°ï¼š
#   year       : æ•°å€¤/æ–‡å­—åˆ—
#   bands      : build_station_bands() ã®æˆ»ã‚Šï¼ˆNULL ã®å ´åˆã¯ STATIONS_OUT_RDS ã‹ã‚‰ä½œæˆï¼‰
#   price_var  : summarise_bands() ã«åŒã˜
#   agg        : summarise_bands() ã«åŒã˜
#   min_pts    : summarise_bands() ã«åŒã˜
# è¿”ã‚Šå€¤ï¼š
#   data.frameï¼ˆgeometry ãªã—ï¼‰
# å‚™è€ƒï¼š
#   ãƒ»bands ãŒ NULL ã®å ´åˆã€ã“ã®å ´ã§é§…RDSâ†’ build_station_bands() ã§ç”Ÿæˆã—ã¾ã™
# =============================================================================
build_panel_for_year <- function(year,
                                 bands     = NULL,
                                 price_var = c("log_price","price_yen_m2"),
                                 agg       = c("mean","median"),
                                 min_pts   = 3L) {
  # é§…Ã—è·é›¢å¸¯ï¼ˆãƒãƒªã‚´ãƒ³ï¼‰ã‚’ç”¨æ„
  if (is.null(bands)) {
    # é§…ãƒ•ãƒ©ã‚°ä»˜ã sf ã‚’èª­ã¿ã€é–¢æ•°ã§ãƒªãƒ³ã‚°ç”Ÿæˆ
    if (!exists("build_station_bands")) {
      stop("build_station_bands() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚fn_build_station_bands.R ã‚’ source ã—ã¦ãã ã•ã„ã€‚")
    }
    bands <- build_station_bands(stn_flag = NULL, preview = FALSE)
  }

  # L02 ã‚’èª­ã¿è¾¼ã¿
  l02_sf <- read_l02_year(year)

  # ç©ºé–“çµåˆ
  joined <- join_l02_to_bands(l02_sf, bands, join_fun = sf::st_within)

  # é›†è¨ˆã—ã¦è¿”ã™
  summarise_bands(joined, price_var = price_var, agg = agg, min_pts = min_pts)
}

# =============================================================================
# 6) è¤‡æ•°å¹´ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ãƒ•ãƒ«ãƒ»ãƒ‘ãƒãƒ«ã‚’ä½œã‚‹
# -----------------------------------------------------------------------------
# å¼•æ•°ï¼š
#   years     : ä¾‹ 2009:2025
#   bands     : äº‹å‰ã« build_station_bands() æ¸ˆã¿ã® sfï¼ˆNULL ãªã‚‰ä¸­ã§ç”Ÿæˆï¼‰
#   write_rds : RDS ã®ä¿å­˜ãƒ‘ã‚¹ï¼ˆNULL ãªã‚‰ä¿å­˜ã—ãªã„ï¼‰
#   write_csv : CSV ã®ä¿å­˜ãƒ‘ã‚¹ï¼ˆNULL ãªã‚‰ä¿å­˜ã—ãªã„ï¼‰
# è¿”ã‚Šå€¤ï¼š
#   data.frameï¼ˆå…¨å¹´åº¦çµåˆï¼‰
# =============================================================================
build_station_band_panel <- function(years,
                                     bands     = NULL,
                                     write_rds = NULL,
                                     write_csv = NULL,
                                     price_var = c("log_price","price_yen_m2"),
                                     agg       = c("mean","median"),
                                     min_pts   = 3L) {
  # bands æº–å‚™ï¼ˆ1å›ã ã‘ä½œã‚‹ï¼‰
  if (is.null(bands)) {
    if (!exists("build_station_bands")) {
      stop("build_station_bands() ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚fn_build_station_bands.R ã‚’ source ã—ã¦ãã ã•ã„ã€‚")
    }
    bands <- build_station_bands(stn_flag = NULL, preview = FALSE)
  }

  # å¹´ãƒ«ãƒ¼ãƒ—ã§çµåˆ
  panel_list <- lapply(as.list(years), function(y) {
    message(">> å¹´ ", y, " ã®ãƒ‘ãƒãƒ«ã‚’ä½œæˆä¸­ â€¦")
    build_panel_for_year(y, bands = bands,
                         price_var = price_var, agg = agg, min_pts = min_pts)
  })
  panel <- dplyr::bind_rows(panel_list)

  # ä¿å­˜ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
  if (!is.null(write_rds)) {
    dir.create(dirname(write_rds), recursive = TRUE, showWarnings = FALSE)
    saveRDS(panel, write_rds)
  }
  if (!is.null(write_csv)) {
    dir.create(dirname(write_csv), recursive = TRUE, showWarnings = FALSE)
    readr::write_csv(panel, write_csv)
  }

  panel
}
===== END code/fn_build_station_band_panel.R =====


===== BEGIN code/02_config_params.R =====
#code/02_config_params.R

#åº§æ¨™
EPSG_WGS84 <- 4326
EPSG_METRIC <- 6697   # Japan plane metricï¼ˆè·é›¢è¨ˆæ¸¬ç”¨ï¼‰

# --- å¹´ãƒ»è·é›¢å¸¯ ---
YEARS_ANALYZE <- 2009:2025
BAND_BREAKS_KM <- c(0, 1, 3, 5)  # è¿‘:0-1 / ä¸­:1-3 / é :3-5
===== END code/02_config_params.R =====


===== BEGIN code/fn_convert_randplace_geojson.R =====
#code/fn_convert_randplace_geojson.R
#2017å¹´ä»¥å‰ã®ã‚‚ã®ãŒgeojsonå½¢å¼ã§é…å¸ƒã•ã‚Œã¦ã„ãªã‹ã£ãŸãŸã‚shapefileã‚’å¤‰æ›ã—ã¦å½¢å¼ã‚’æƒãˆã‚‹
#2013ãƒ»2014å¹´, 2015å¹´ã®ä¸€éƒ¨ã¯ä»–ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆãŒé•ã†ã½ã„

library(sf)
library(stringr)
library(here)

convert_l02_to_geojson <- function(year_short) {
  base_dir <- here("data_raw", "ksj_l02_landprice")
  in_dir   <- here("data_raw", "ksj_l02_landprice", "shapefile", paste0("l02_", year_short))
  out_dir  <- here("data_raw", "ksj_l02_landprice", paste0("20", year_short))
  dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
  
  # tmp_L02-XX_YY ã¾ãŸã¯ tmp_L02-XX_YY_GML ã®ä¸¡æ–¹ã«å¯¾å¿œ
  gml_dirs <- list.dirs(in_dir, recursive = FALSE, full.names = TRUE)
  gml_dirs <- gml_dirs[str_detect(basename(gml_dirs), "^tmp_L02-\\d{2}_\\d{2}(_GML)?$")]
  
  if (length(gml_dirs) == 0) {
    warning(paste("âš ï¸ No tmp_L02 directories found for year", year_short))
    return(NULL)
  }
  
  for (dir_path in gml_dirs) {
    dir_name <- basename(dir_path)
    matches <- str_match(dir_name, "tmp_L02-(\\d{2})_(\\d{2})(?:_GML)?")
    year <- matches[,2]
    pref_code <- matches[,3]
    
    # .shp ã‚’å†å¸°çš„ã«æ¢ç´¢ï¼ˆå¤§æ–‡å­—ãƒ»å°æ–‡å­—ä¸¡å¯¾å¿œï¼‰
    shp_files <- list.files(dir_path, pattern = "\\.[sS][hH][pP]$", full.names = TRUE, recursive = TRUE)
    
    if (length(shp_files) == 0) {
      message("âŒ No shapefile found in ", dir_path)
      next
    }
    
    shp_path <- shp_files[1]
    message("ğŸ“‚ Reading ", basename(shp_path), " ...")
    
    gdf <- tryCatch(
      st_read(shp_path, options = "ENCODING=CP932", quiet = TRUE),
      error = function(e) { message("Error reading: ", shp_path); return(NULL) }
    )
    if (is.null(gdf)) next
    
    # CRSãŒãªã„å ´åˆã¯JGD2000ã¨ä»®å®š
    if (is.na(st_crs(gdf))) {
      message("âš ï¸ No CRS detected, assigning EPSG:4612 (JGD2000)")
      gdf <- st_set_crs(gdf, 4612)
    }
    
    # JGD2011ã«çµ±ä¸€
    gdf <- st_transform(gdf, 6668)
    
    out_path <- file.path(out_dir, paste0("L02-", year, "_", pref_code, ".geojson"))
    st_write(gdf, out_path, driver = "GeoJSON", delete_dsn = TRUE, quiet = TRUE)
    message("âœ… Saved: ", out_path)
  }
  
  message("ğŸ‰ Conversion completed for year 20", year_short)
}

# è¤‡æ•°å¹´ï¼ˆä¾‹ï¼š2009ã€œ2017ï¼‰
years <- sprintf("%02d", 9:17)
logs  <- lapply(years, convert_l02_to_geojson)

===== END code/fn_convert_randplace_geojson.R =====


===== BEGIN script/11_01_build_stations.R =====
#script/11_01_build_station.R

#dir.create(dirname(OUT_GJ), showWarnings = FALSE, recursive = TRUE)
library(sf)
library(dplyr)
library(stringi)
library(here)

source(here("code", "01_config_paths.R"))
source(here("code", "02_config_params.R"))
source(here("code", "03_util_strings.R"))
source(here("code", "04_util_qa.R"))
source(here("data_ref", "stops_shinkansen.R"))

#è¡Œæ”¿ç•Œãƒ¦ãƒ‹ã‚ªãƒ³ã‚’èª­ã¿è¾¼ã¿
adm_u <- readRDS(ADM_UNION_RDS)

#é§…geojsonãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
station_raw <- sf::st_read(STATION_GJ, quiet=TRUE) |>
  sf::st_transform(EPSG_WGS84)

#N02_003ãŒè·¯ç·šå, N02_005ãŒé§…å
#å¿…è¦ãªåˆ—ã®ã¿ã«çµã£ã¦ãƒ©ãƒ™ãƒ«å¼µã‚Šæ›¿ãˆ
stn <- station_raw |>
  transmute(
    line     = N02_003,
    station  = N02_005,
    geometry = geometry
  ) |>
  mutate(
    station_key = norm_ja(station),
    line_key    = norm_ja(line)
  )
#è·¯ç·šåãŒæ±æµ·é“æ–°å¹¹ç·šã®ã‚‚ã®ã®ã¿æŠ½å‡º
stn_tokaido <- stn |> filter(line_key == norm_ja("æ±æµ·é“æ–°å¹¹ç·š"))
#åŒåé‡è¤‡ã‚’å–ã‚Šé™¤ã
stn_tokaido <- stn_tokaido |> distinct(station_key, .keep_all = TRUE)

#å¿µã®ç‚ºæ‰‹å…¥åŠ›ã—ãŸåœè»Šé§…ãƒªã‚¹ãƒˆã‚‚æ´—ã£ã¦ãŠã
NOZOMI_KEY <- norm_ja(NOZOMI)
HIKARI_KEY <- norm_ja(HIKARI)
KODAMA_KEY <- norm_ja(KODAMA)

#é§…æ¯ã«ã²ã‹ã‚Šãƒ»ã®ãã¿ã®åœè»Šæœ‰ç„¡ã§ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
stn_flag <- stn_tokaido |>
  mutate(
    nozomi = as.integer(station_key %in% NOZOMI_KEY),
    hikari = as.integer(station_key %in% HIKARI_KEY),
    #ä¸€å¿œåºåˆ—ä»˜ä¸
    service_tier = case_when(
      nozomi == 1L ~ 2L,
      hikari == 1L ~ 1L,
      TRUE         ~ 0L
    )
  ) |>
  arrange(desc(nozomi), desc(hikari), station)

#å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®šç¾©
STATIONS_OUT_GJ <- file.path(OUT_DIR_GJ, "tokaido_stations_flags.geojson")
STATIONS_OUT_RDS <- file.path(OUT_DIR_RDS, "tokaido_stations_flags.rds")

# å‡ºåŠ›
dir.create(dirname(STATIONS_OUT_GJ), showWarnings = FALSE, recursive = TRUE)
dir.create(dirname(STATIONS_OUT_RDS), showWarnings = FALSE, recursive = TRUE)

sf::st_write(stn_flag, STATIONS_OUT_GJ, delete_dsn = TRUE, quiet = TRUE)
saveRDS(stn_flag, STATIONS_OUT_RDS)

#qaå‡¦ç†
if (qa_on()) {
  p <- ggplot(stn_flag) +
    geom_sf(aes(color = factor(service_tier)), size = 2) +
    ggrepel::geom_text_repel(aes(label = station), size = 3, max.overlaps = 30) +
    labs(title = "Tokaido Shinkansen stations by stop tier",
         color = "tier (2:nozomi,1:hikari,0:kodama)")
  qa_png(p, "12_stations_by_tier")
}

===== END script/11_01_build_stations.R =====


===== BEGIN script/00_00_install_packages.R =====
#script/00_00_install_packages.R

install.packages("cartogram")
install.packages("estimatr")
install.packages("fixest")
install.packages("GGally")
install.packages("mapview")
install.packages("mlogit")
install.packages("modelsummary")
install.packages("nngeo")
install.packages("openxlsx")
install.packages("osrm")
install.packages("plotly")
install.packages("psych")
install.packages("RColorBrewer")
install.packages("sf")
install.packages("spatialreg")
install.packages("spData")
install.packages("spdep")
install.packages("tidyverse")
install.packages("units")
install.packages("dplyr")
install.packages("stringr")
install.packages("tibble")
install.packages("janitor")
install.packages("purrr")
install.packages("readr")
install.packages("here")
install.packages("languageserver")
===== END script/00_00_install_packages.R =====


===== BEGIN script/21_01_build_full_panel.R =====

===== END script/21_01_build_full_panel.R =====


===== BEGIN script/11_02_build_admin_union.R =====
#script/11_02_build_admin_union.R

library(sf)
library(purrr)
source(here("code","04_util_qa.R"))

#è¡Œæ”¿ç•Œãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã‚‹
adm_files <- list.files(ADM_DIR, pattern="\\.geojson$", full.names=TRUE)

#liståŒ–ãƒ»åº§æ¨™ç³»çµ±ä¸€
adm_list <- map(adm_files, ~ sf::st_read(.x, quiet = TRUE) |>
                  sf::st_transform(EPSG_WGS84))
#çµåˆ
adm <- do.call(rbind, adm_list)

# ãƒˆãƒãƒ­ã‚¸æ•´å‚™
adm <- sf::st_make_valid(adm)

#è¤‡æ•°çœŒã®çµåˆã‚’çµ±åˆ
adm_u <- sf::st_union(sf::st_geometry(adm))


#å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®šç¾©
ADM_UNION_GJ <- file.path(OUT_DIR_GJ, "adm_union_8pref.geojson")
ADM_UNION_RDS <- file.path(OUT_DIR_RDS, "adm_union_8pref.rds")

# å‡ºåŠ›
dir.create(dirname(ADM_UNION_GJ), showWarnings = FALSE, recursive = TRUE)
dir.create(dirname(ADM_UNION_RDS), showWarnings = FALSE, recursive = TRUE)

sf::st_write(sf::st_as_sf(adm_u), ADM_UNION_GJ, delete_dsn = TRUE, quiet = TRUE)
saveRDS(adm_u, ADM_UNION_RDS)

#qaå‡¦ç†
if (qa_on()) {
  p <- ggplot() +
    geom_sf(data = adm, color = "grey70", fill = NA, linewidth = 0.3) +
    geom_sf(data = sf::st_as_sf(adm_u), color = "red", fill = NA, linewidth = 0.6) +
    labs(title = "Admin union (outline check)")
  qa_png(p, "21_admin_union_outline")
}

===== END script/11_02_build_admin_union.R =====


===== BEGIN data_ref/stops_shinkansen.R =====
#data_ref/stops_shinkansen.R

# ================================
# æ±æµ·é“æ–°å¹¹ç·š åœè»Šé§… å®šç¾©ï¼ˆæ‰‹å…¥åŠ›ãƒ»æ˜ç¤ºï¼‰
# æ›´æ–°æ—¥: 2025-11-06
# æ–¹é‡:
#  - ALL_TOKAIDO: æ±æµ·é“æ–°å¹¹ç·šã®å…¨é§…ï¼ˆ17é§…ï¼‰
#  - NOZOMI: ã®ãã¿åœè»Šé§…ï¼ˆä»£è¡¨6é§…ï¼‰
#  - HIKARI: ã²ã‹ã‚Šåœè»Šé§…ï¼ˆä»£è¡¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šã®ãã¿ + è¿½åŠ 8é§…ï¼‰
#  - KODAMA: ã“ã ã¾åœè»Šé§…ï¼ˆ= å…¨é§…ï¼‰
# ================================

LINE_NAME <- "æ±æµ·é“æ–°å¹¹ç·š"

ALL_TOKAIDO <- c(
  "æ±äº¬", "å“å·", "æ–°æ¨ªæµœ", "å°ç”°åŸ", "ç†±æµ·", "ä¸‰å³¶", "æ–°å¯Œå£«", "é™å²¡",
  "æ›å·", "æµœæ¾", "è±Šæ©‹", "ä¸‰æ²³å®‰åŸ", "åå¤å±‹", "å²é˜œç¾½å³¶", "ç±³åŸ", "äº¬éƒ½", "æ–°å¤§é˜ª"
)

NOZOMI <- c("æ±äº¬", "å“å·", "æ–°æ¨ªæµœ", "åå¤å±‹", "äº¬éƒ½", "æ–°å¤§é˜ª")

HIKARI <- union(
  NOZOMI, c("å°ç”°åŸ", "ç†±æµ·", "ä¸‰å³¶", "é™å²¡", "æµœæ¾", "è±Šæ©‹", "å²é˜œç¾½å³¶", "ç±³åŸ")
)

KODAMA <- ALL_TOKAIDO


===== END data_ref/stops_shinkansen.R =====
